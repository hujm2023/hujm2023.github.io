<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>彻底理解Linux Select中的FD_SET | hujm2023&#39;s blog</title>
<meta name="keywords" content="Linux, 多路复用, select">
<meta name="description" content="看 select 源码，fd_set 这个结构体实际上是一个 long 型的数组，但是数组的长度依赖于系统中 typedef long int __fd_mask 的长度。当我去调试的时候，经常打印出一些很奇怪的值，有时候还会溢出。">
<meta name="author" content="JemmyHu(hujm20151021@gmail.com)">
<link rel="canonical" href="http://localhost:1313/posts/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3linux-select%E4%B8%AD%E7%9A%84fd_set/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css" integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn&#43;yY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/%E5%BD%BB%E5%BA%95%E7%90%86%E8%A7%A3linux-select%E4%B8%AD%E7%9A%84fd_set/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="hujm2023&#39;s blog (Alt + H)">hujm2023&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      彻底理解Linux Select中的FD_SET
    </h1>
    <div class="post-meta"><span title='2021-05-08 21:00:42 +0800 CST'>May 8, 2021</span>&nbsp;·&nbsp;<span>JemmyHu(hujm20151021@gmail.com)</span>

</div>
  </header> 
<figure class="entry-cover">
        <img loading="eager" src="https://pic.downk.cc/item/5f61dc63160a154a6777224d.png" alt="">
        
</figure>
  <div class="post-content"><p>看 <code>select</code> 源码，<code>fd_set</code> 这个结构体实际上是一个 <code>long</code> 型的数组，但是数组的长度依赖于系统中 <code>typedef long int __fd_mask</code> 的长度。当我去调试的时候，经常打印出一些很奇怪的值，有时候还会溢出。</p>
<p>本文旨在抛开 <code>select</code> 相关的功能，彻底搞明白 <code>fd_set</code> 的存储原理、<code>FD_SET()</code> 等函数到底实现了什么效果。</p>
<p>本次调试机器：</p>
<pre tabindex="0"><code>$ uname -a
Linux localhost 4.15.0-52-generic #56-Ubuntu SMP Tue Jun 4 22:49:08 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p><code>fd_set</code> 的源码中有非常多的预编译指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// /usr/include/x86_64-linux-gnu/sys/select.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* The fd_set member is required to be an array of longs.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> __fd_mask;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Some versions of &lt;linux/posix_types.h&gt; define this macros.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#undef __NFDBITS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* It&#39;s easier to assume 8-bit bytes than to get CHAR_BIT.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NFDBITS (8 * (int) sizeof (__fd_mask))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __FD_MASK(d) ((__fd_mask) (1UL &lt;&lt; ((d) % __NFDBITS)))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* fd_set for select and pselect.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* XPG4.2 requires this member name.  Otherwise avoid the name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       from the global namespace.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef __USE_XOPEN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __fd_mask fds_bits[__FD_SETSIZE <span style="color:#f92672">/</span> __NFDBITS];
</span></span><span style="display:flex;"><span><span style="color:#75715e"># define __FDS_BITS(set) ((set)-&gt;fds_bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    __fd_mask __fds_bits[__FD_SETSIZE <span style="color:#f92672">/</span> __NFDBITS];
</span></span><span style="display:flex;"><span><span style="color:#75715e"># define __FDS_BITS(set) ((set)-&gt;__fds_bits)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } fd_set;
</span></span></code></pre></div><p>我简单整理一下，去掉和本系统无关的，结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> __fd_mask;  <span style="color:#75715e">// 8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define __NFDBITS (8 * (int) sizeof (__fd_mask)  </span><span style="color:#75715e">// 64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define __FD_SETSIZE  1024
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    __fd_mask __fds_bits[__FD_SETSIZE <span style="color:#f92672">/</span> __NFDBITS];  <span style="color:#75715e">// 长度为 1024/64=16，类型为 long 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} fd_set;
</span></span></code></pre></div><p>接着，我们看一个 demo：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/select.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_set1</span>(fd_set <span style="color:#f92672">*</span>fdset);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_set2</span>(fd_set <span style="color:#f92672">*</span>fdset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    fd_set fdset;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_ZERO</span>(<span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;sizeof long int: %ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span>)); <span style="color:#75715e">// 8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;sizeof int: %ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>));           <span style="color:#75715e">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;sizeof short: %ld</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">short</span>));       <span style="color:#75715e">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">2</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">7</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_set1</span>(<span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 10001110 -&gt; 第 1 2 3 7 位分别设置成了 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">15</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">16</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">31</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 10000000000000011000000010001110 -&gt; 长度为 32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">32</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">33</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">62</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 100000000000000000000000000001110000000000000011000000010001110 0-&gt;长度为 63
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">print_set2</span>(<span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">63</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 1100000000000000000000000000001110000000000000011000000010001110 0 -&gt; 长度为 64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">print_set2</span>(<span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">64</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 1100000000000000000000000000001110000000000000011000000010001110 1 -&gt; 长度还是 64，但产生了进位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">print_set2</span>(<span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">128</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 1100000000000000000000000000001110000000000000011000000010001110 1 1-&gt; 长度还是 63，但是在 64 和 128 的时候产生了进位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">129</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 1100000000000000000000000000001110000000000000011000000010001110 1 3-&gt; 长度还是 63，但是在 64 和 128 的时候产生了进位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">1023</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 13835058070314647694 1 3 0 0 0 0 0 0 0 0 0 0 0 0 9223372036854775808
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">1024</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 13835058070314647694 1 3 0 0 0 0 0 0 0 0 0 0 0 0 9223372036854775808
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#ae81ff">1025</span>, <span style="color:#f92672">&amp;</span>fdset); <span style="color:#75715e">// 13835058070314647694 1 3 0 0 0 0 0 0 0 0 0 0 0 0 9223372036854775808
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">print_set2</span>(<span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> isset <span style="color:#f92672">=</span> <span style="color:#a6e22e">FD_ISSET</span>(<span style="color:#ae81ff">7</span>, <span style="color:#f92672">&amp;</span>fdset); 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;isset = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, isset);<span style="color:#75715e">// 输出 1，代表第 7 位被设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">FD_CLR</span>(<span style="color:#ae81ff">7</span>, <span style="color:#f92672">&amp;</span>fdset);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">print_set2</span>(<span style="color:#f92672">&amp;</span>fdset);           <span style="color:#75715e">// 1100000000000000000000000000001110000000000000011000000000001110 1 3 0 0 0 0 0 0 0 0 0 0 0 0 9223372036854775808 -&gt; 第 7 位的 1 变成了 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    isset <span style="color:#f92672">=</span> <span style="color:#a6e22e">FD_ISSET</span>(<span style="color:#ae81ff">7</span>, <span style="color:#f92672">&amp;</span>fdset); 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;isset = %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, isset);<span style="color:#75715e">// 输出 0，代表第 7 位没有被设置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_set2</span>(fd_set <span style="color:#f92672">*</span>fdset)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%llu &#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>)fdset<span style="color:#f92672">-&gt;</span>__fds_bits[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print_set1</span>(fd_set <span style="color:#f92672">*</span>fdset)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">16</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%ld &#34;</span>,fdset<span style="color:#f92672">-&gt;</span>__fds_bits[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>print_set()</code> 函数是我自己添加的，用于打印出 <code>fd_set</code> 中的 <code>__fds_bits</code> 数组中的内容。需要注意两点：</p>
<ol>
<li>
<p>数组长度是 16，是如何确定的？答：在处理过预编译指令之后，<code>__FD_SETSIZE</code> 的值是 <code>1024</code>，<code>__NFDBITS</code> 的值是 <code>64</code>，计算得到数组长度为 16；</p>
</li>
<li>
<p>类型的长度如何确定？答：在最开始使用了 <code>typedef long int __fd_mask</code>，<code>long int</code> 其实就是 <code>long</code>，即 <code>long signed integer type</code>。熟悉 C语言的同学都知道，当我们描述 <code>short</code>、<code>int</code> 和 <code>long</code> 的长度时，只有对 <code>short</code> 的长度是肯定的，而对后两者都使用了 <strong>可能</strong> 的说法：可能长度为 <code>8</code>。这是因为 C语言 没有对其做出严格的规定，只做了宽泛的限制：<code>short</code> 占 <code>2字节</code>；<code>int</code> 建议为机器字长，64 位机器下占<code>4字节</code>；<code>2 ≤ short ≤ int ≤ long</code>，如上述代码中打印结果所示，在我测试的这台机器上，<code>long</code> 占 <code>8字节</code> 即 <code>64位</code>。</p>
</li>
</ol>
<p>接下来我们看 <code>main()</code> 中的代码：</p>
<p>在调用 <code>FD_SET()</code> 设置 1 2 3 7 后，我们调用<code>print_set1()</code>打印结果，输出：<code>142 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code>，数组第一位竟然是 <code>142</code>？！哪来的？但我们将 <code>142</code> 转成二进制就一下子了然了：<code>10001110</code>， 总共占 8 位，从右往左从 0 开始数，只有第 1 2 3 7 位被设置成了 1， 这个二进制对应的数就是 142，因为 142 完全在一个 <code>long</code> 的范围(64位)内，所以正常表示了。那如果我们对一个超过 <code>long</code> 范围的数调用 <code>FD_SET()</code>，会是什么效果？</p>
<p>代码继续走到 <code>FD_SET(62, &amp;fdset)</code>，我们调用 <code>print_set1()</code>，输出 <code>4611686033459871886 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code>，<code>4611686033459871886</code> 转成二进制为 <code>100000000000000000000000000001110000000000000011000000010001110</code>，字符串长度为 63，可以看到，依旧在 <code>long</code> 的范围之内；执行到 <code>FD_SET(63,&amp;fdset)</code> 呢，调用 <code>print_set1()</code>，输出 <code>-4611686003394903922 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code>，出现了负数。我们想一下原因。只执行<code>FD_SET(62,&amp;fdset)</code> 会将第 63 位处设置为 1，对应的二进制为 <code>100000000000000000000000000000000000000000000000000000000000000</code>(长度为 63)；根据 <code>FD_SET()</code> 的功能，我们可以猜测，<code>FD_SET(63,&amp;fdset)</code> 会将第 64 位设置为 1，其对应的二进制应该是 <code>1000000000000000000000000000000000000000000000000000000000000000</code>(长度为 64)。</p>
<blockquote>
<p>在这里我们补充一个知识：参考这里 <a href="https://zh.wikipedia.org/wiki/%E6%97%A0%E7%AC%A6%E5%8F%B7%E6%95%B0">Wiki-无符号数</a>，在计算机底层，有符号数可以表示特定范围内的整数(包括负数)，无符号数只能表示非负数(0 以及正数)，有符号数能够表示负数的原因是，最高位被用来当做符号位，1 表示负数，0 表示正数，代价就是所表示的数的范围少了一半，举个例子，8 位可以表示无符号数 [0,255](最小<code>00000000</code>；最大<code>11111111</code>，对应的十进制就是 255)，对应的有符号数范围就是 [-127,127]。</p></blockquote>
<p>再回头看 <code>1000000000000000000000000000000000000000000000000000000000000000</code>，<code>__fd_mask</code> 的类型是 <code>long</code>，是一个有符号数，最高位的 1 表示负数，后面的才是真正的值，于是这个二进制转成有符号十进制的结果就是 <code>0</code>，而且还是个 <code>-0</code>。为了验证我们的想法，我们将 <code>print_set1()</code> 换成 <code>print_set2()</code>，这两个函数唯一的不同是，将数组中的每一位的类型强转成了无符号数，这下结果就成了 <code>9223372036854775808</code>，符合我们的预期。 所以后面的调试，我们都使用 <code>print_set2()</code> 这个函数。</p>
<p>刚才的 <code>FD_SET(63,&amp;fdset)</code> 已经到达一个 <code>long</code> 的最大可 表示范围了，如果再多一位，会发生什么？我们看下 <code>FD_SET(64, &amp;fdset)</code>，输出 <code>13835058070314647694 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0</code>，<code>13835058070314647694</code> 转换成二进制后为 <code>1100000000000000000000000000001110000000000000011000000010001110</code>(长度为 64)，和 设置 63 时的一样，但数组的第二位变成了 1。按照前面的推测，单独执行 <code>FD_SET(64, &amp;fdset)</code>，应该将第 65 位设置成 1，长度为 65，但是 65 显然超过了 <code>long</code> 的可表示的长度(64位)，于是，产生了“进位”，这个进位的基本单位就是 64位，即 <code>__NFDBITS</code> 的值。于是，可以用如下 python 代码表示(python 对大数处理非常好，一般不会出现溢出)：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/local/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># coding:utf-8</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get_fd_set_bin 返回 fd_set 表示的真实二进制(从右往左方向)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># every_fd_bits 表示数组中每个元素代表多少位</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set_array 表示 fd_set 的 long 数组</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_fd_set_bin</span>(every_fd_bits, set_array):
</span></span><span style="display:flex;"><span>    int_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> idx <span style="color:#f92672">in</span> range(len(set_array)):
</span></span><span style="display:flex;"><span>        int_value <span style="color:#f92672">=</span> int_value <span style="color:#f92672">|</span> (set_array[idx] <span style="color:#f92672">&lt;&lt;</span> every_fd_bits <span style="color:#f92672">*</span> idx)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> bin(int_value)[<span style="color:#ae81ff">2</span>:]  <span style="color:#75715e"># 输出 &#34;0bxxxxxx&#34;，为了方便展示，去掉前缀</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print_bin 将二进制按照 step 为一组打印</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_bin</span>(output, step<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>):
</span></span><span style="display:flex;"><span>    le <span style="color:#f92672">=</span> len(output)
</span></span><span style="display:flex;"><span>    m <span style="color:#f92672">=</span> le <span style="color:#f92672">%</span> step
</span></span><span style="display:flex;"><span>    padding <span style="color:#f92672">=</span> step <span style="color:#f92672">-</span> m <span style="color:#66d9ef">if</span> m <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>zfill(le <span style="color:#f92672">+</span> padding)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39; &#39;</span><span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join(output[idx <span style="color:#f92672">*</span> step:(idx <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> step]) <span style="color:#66d9ef">for</span> idx <span style="color:#f92672">in</span> range((le <span style="color:#f92672">+</span> padding) <span style="color:#f92672">//</span> step)))
</span></span></code></pre></div><p>在我们当前的例子中，<code>every_fd_bits = 64</code>, <code>set_array</code> 的长度为 16。测试一下我们的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 输入(相当于设置了 1 2 3 7)</span>
</span></span><span style="display:flex;"><span>get_fd_set_bin<span style="color:#f92672">(</span>64, <span style="color:#f92672">[</span>142,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输出 </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000000000000000000000000000000000000000000000000000010001110</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输入(相当于设置了 1 2 3 7 64)</span>
</span></span><span style="display:flex;"><span>get_fd_set_bin<span style="color:#f92672">(</span>64, <span style="color:#f92672">[</span>142,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 输出</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0000000000000000000000000000000000000000000000000000000000000001</span> <span style="color:#ae81ff">0000000000000000000000000000000000000000000000000000000010001110</span>
</span></span></code></pre></div><p>我用 Golang 做了简单实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;math/big&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FdSet</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_CLR</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_ISSET</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_SET</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FD_ZERO</span>() <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">FdSetString</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">fdType</span> <span style="color:#66d9ef">uint64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">maxFdSetSize</span> = <span style="color:#ae81ff">1024</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fdMask</span>       = <span style="color:#ae81ff">8</span> <span style="color:#75715e">// sizeof long int in c</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fdBits</span>       = <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">fdMask</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FdSetGolang</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">data</span> [<span style="color:#a6e22e">maxFdSetSize</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">fdBits</span>]<span style="color:#a6e22e">fdType</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewGdSetGolang</span>() <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">FdSetGolang</span>{<span style="color:#a6e22e">data</span>: [<span style="color:#a6e22e">maxFdSetSize</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">fdBits</span>]<span style="color:#a6e22e">fdType</span>{}}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">FD_CLR</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span>.clear(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">getMask</span>(<span style="color:#a6e22e">fd</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">FD_ISSET</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) (<span style="color:#66d9ef">bool</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">isSet</span>(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">getMask</span>(<span style="color:#a6e22e">fd</span>)), <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">FD_SET</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">getMask</span>(<span style="color:#a6e22e">fd</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">FD_ZERO</span>() <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span>] = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">FdSetString</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">string</span>, <span style="color:#ae81ff">0</span>, len(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">--</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">uintBin</span>(uint64(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span>])); <span style="color:#a6e22e">v</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">tmp</span> = append(<span style="color:#a6e22e">tmp</span>, <span style="color:#a6e22e">v</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 最左边的那个，可以将前面的 0 全部去掉</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">tmp</span>) &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">tmp</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; len(<span style="color:#a6e22e">t</span>); <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">t</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;0&#39;</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">tmp</span>[<span style="color:#ae81ff">0</span>] = <span style="color:#a6e22e">t</span>[<span style="color:#a6e22e">i</span>:]
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;--&gt;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>(<span style="color:#a6e22e">tmp</span>, <span style="color:#e6db74">&#34; &#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&lt;--&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">getMask</span>(<span style="color:#a6e22e">fd</span> <span style="color:#66d9ef">int</span>) (<span style="color:#a6e22e">idx</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fd</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">fdBits</span>, <span style="color:#a6e22e">fd</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">fdBits</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// set 将数组下标为 idx 的数的从右往左数的第(n+1)位设置为 1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">idx</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">old</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">idx</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">idx</span>] = <span style="color:#ae81ff">1</span><span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">n</span> | <span style="color:#a6e22e">old</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// clear 将数组下标为 idx 的数的从右往左数的第(n+1)位设置为 0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) clear(<span style="color:#a6e22e">idx</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">isSet</span>(<span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">n</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">idx</span>] ^= <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">n</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">isSet</span>(<span style="color:#a6e22e">idx</span>, <span style="color:#a6e22e">n</span> <span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">old</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">idx</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">this</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#a6e22e">n</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> int(<span style="color:#a6e22e">old</span>)<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">this</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">this</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// uintBin 输出 n 的二进制表示</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">FdSetGolang</span>) <span style="color:#a6e22e">uintBin</span>(<span style="color:#a6e22e">n</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">big</span>.<span style="color:#a6e22e">NewInt</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">SetUint64</span>(<span style="color:#a6e22e">n</span>).<span style="color:#a6e22e">Text</span>(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Repeat</span>(<span style="color:#e6db74">&#34;0&#34;</span>, <span style="color:#a6e22e">fdBits</span><span style="color:#f92672">-</span>len(<span style="color:#a6e22e">s</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/linux/">Linux</a></li>
      <li><a href="http://localhost:1313/tags/%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/">多路复用</a></li>
      <li><a href="http://localhost:1313/tags/select/">Select</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">hujm2023&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
