<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>使用ghz压测GRPC接口 | hujm2023&#39;s blog</title>
<meta name="keywords" content="效率, ghz, 压测GRPC接口">
<meta name="description" content="一、前言
公司后端服务已经全部微服务化，想要调试某个服务可以使用 grpcui，但要对某个接口进行压测，grpcui 还做不到。诸多努力之后找到本次主角：https://github.com/bojand/ghz，官网：ghz.sh。
推荐理由：简洁！可以一次性解决掉 proto 文件相互之间引用的烦心事！">
<meta name="author" content="JemmyHu(hujm20151021@gmail.com)">
<link rel="canonical" href="http://localhost:1313/posts/%E4%BD%BF%E7%94%A8ghz%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css" integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn&#43;yY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/%E4%BD%BF%E7%94%A8ghz%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="hujm2023&#39;s blog (Alt + H)">hujm2023&#39;s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="首页">
                    <span>首页</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="文章">
                    <span>文章</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="标签">
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/categories/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="搜索">
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      使用ghz压测GRPC接口
    </h1>
    <div class="post-meta"><span title='2020-11-09 19:35:34 +0800 CST'>November 9, 2020</span>&nbsp;·&nbsp;<span>JemmyHu(hujm20151021@gmail.com)</span>

</div>
  </header> 
  <div class="post-content"><h2 id="一前言">一、前言<a hidden class="anchor" aria-hidden="true" href="#一前言">#</a></h2>
<p>公司后端服务已经全部微服务化，想要调试某个服务可以使用 <a href="https://github.com/fullstorydev/grpcui"><code>grpcui</code></a>，但要对某个接口进行压测，<code>grpcui</code> 还做不到。诸多努力之后找到本次主角：<a href="https://github.com/bojand/ghz">https://github.com/bojand/ghz</a>，官网：<a href="https://ghz.sh">ghz.sh</a>。</p>
<p>推荐理由：简洁！可以一次性解决掉 <code>proto</code> 文件相互之间引用的烦心事！</p>
<h2 id="二使用">二、使用<a hidden class="anchor" aria-hidden="true" href="#二使用">#</a></h2>
<blockquote>
<p>这里只介绍在 <code>Mac</code> 环境下的用法，其他环境请参阅官网。</p>
<p>另：我们仍旧使用 <code>GOPATH</code> 方式来管理包，我的： <code>export GOPATH=/Users/hujiaming/go </code>，本次测试目录为：<code>/Users/hujiaming/go/src/hujm.net</code>。</p></blockquote>
<h3 id="1-安装">1. 安装<a hidden class="anchor" aria-hidden="true" href="#1-安装">#</a></h3>
<p>直接使用 <code>brew</code> 来安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bas" data-lang="bas"><span style="display:flex;"><span>brew install ghz
</span></span></code></pre></div><p>如果不成功，可以直接去 <a href="https://github.com/bojand/ghz/releases">https://github.com/bojand/ghz/releases</a> 下载二进制，下载后放在 <code>PATH</code> 中即可。</p>
<p><strong>注：还需要有 <code>protoc</code> 工具。</strong></p>
<h3 id="2-生成-protoset-文件">2. 生成 <code>protoset</code> 文件<a hidden class="anchor" aria-hidden="true" href="#2-生成-protoset-文件">#</a></h3>
<p>如果你的 <code>proto</code> 文件中还引用了其他文件，强烈建议使用 <code>protoset</code> 方式。</p>
<p>假如我在如下的 <code>proto</code> 中定义一个 <code>GRPC服务</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @filename: api.proto
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;github.com/mwitkow/go-proto-validators/validator.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/mms2/utils/i18n/moneypb/money.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/fulfillment/offermanager/offerpb/offer.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/fulfillment/offermanager/offerpb/association.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/fulfillment/offermanager/offerpb/supplier.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/core/price/pricepb/price.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> offerpb;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">service</span> ApiService {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>	<span style="color:#66d9ef">rpc</span> CreateSKUAssociations(CreateSKUAssociationsReq) <span style="color:#66d9ef">returns</span> (CreateSKUAssociationsReply) {};<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">CreateSKUAssociationsReq</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">repeated</span> Association associations <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> [ (validator.field) <span style="color:#f92672">=</span> {repeated_count_min <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>} ];<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">CreateSKUAssociationsReply</span> {}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>而 <code>Association</code> 是定义在 <code>&quot;xxx/cm/fulfillment/offermanager/offerpb/association.proto”</code> 文件中的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @filename: association.proto
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>syntax <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;proto3&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;github.com/mwitkow/go-proto-validators/validator.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/mms2/utils/i18n/moneypb/money.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/fulfillment/offermanager/offerpb/supplier.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#34;xxx/cm/core/price/pricepb/price.proto&#34;</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#f92672">package</span> offerpb;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">Association</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">int64</span> offer_id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> [ (validator.field) <span style="color:#f92672">=</span> {int_gt <span style="color:#f92672">:</span> <span style="color:#ae81ff">1000000000</span>} ];<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> sku_code <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> [ (validator.field) <span style="color:#f92672">=</span> {string_not_empty <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>} ];<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>  <span style="color:#66d9ef">string</span> author <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> [ (validator.field) <span style="color:#f92672">=</span> {string_not_empty <span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>} ];<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>如果采用非 <code>protoset</code> 方式，可能要先生成 <code>association.pb.go</code>，再生成 <code>api.pb.go</code> 文件。这里我们采用 <code>protoset</code> 方式，一步到位：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>protoc <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>--include_imports <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-I. -I/usr/local/include <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-I/usr/local/go <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>-I$GOPATH/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>-I$GOPATH/src <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--proto_path<span style="color:#f92672">=</span>. <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>--descriptor_set_out<span style="color:#f92672">=</span>api.bundle.protoset <span style="color:#ae81ff">\ </span>
</span></span><span style="display:flex;"><span>api.proto
</span></span></code></pre></div><p>需要注意的点如下：</p>
<ol>
<li>如果你的 <code>proto</code> 文件中有引用，上述命令中一定要有 <code>include_imports</code> 参数；</li>
<li>在后面运行时如果出现 <code>no descriptor found for &quot;xxxxxx&quot;</code>，可能是某个文件没有通过 <code>-I</code> 引用进来，记得加上重新执行。</li>
</ol>
<p>不出意外，会在当前目录下生成 <code>api.bundle.protoset</code> 文件。</p>
<h3 id="3-执行压测任务">3. 执行压测任务<a hidden class="anchor" aria-hidden="true" href="#3-执行压测任务">#</a></h3>
<p>可以看一下 <code>ghz</code> 的用法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ghz --help
</span></span><span style="display:flex;"><span>usage: ghz <span style="color:#f92672">[</span>&lt;flags&gt;<span style="color:#f92672">]</span> <span style="color:#f92672">[</span>&lt;host&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Flags:
</span></span><span style="display:flex;"><span>  -h, --help                   Show context-sensitive help <span style="color:#f92672">(</span>also try --help-long and --help-man<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>      --config<span style="color:#f92672">=</span>                Path to the JSON or TOML config file that specifies all the test run settings.
</span></span><span style="display:flex;"><span>      --proto<span style="color:#f92672">=</span>                 The Protocol Buffer .proto file.
</span></span><span style="display:flex;"><span>      --protoset<span style="color:#f92672">=</span>              The compiled protoset file. Alternative to proto. -proto takes precedence.
</span></span><span style="display:flex;"><span>      --call<span style="color:#f92672">=</span>                  A fully-qualified method name in <span style="color:#e6db74">&#39;package.Service/method&#39;</span> or <span style="color:#e6db74">&#39;package.Service.Method&#39;</span> format.
</span></span><span style="display:flex;"><span>  -i, --import-paths<span style="color:#f92672">=</span>          Comma separated list of proto import paths. The current working directory and the directory of the protocol buffer file are automatically added to the import list.
</span></span><span style="display:flex;"><span>      --cacert<span style="color:#f92672">=</span>                File containing trusted root certificates <span style="color:#66d9ef">for</span> verifying the server.
</span></span><span style="display:flex;"><span>      --cert<span style="color:#f92672">=</span>                  File containing client certificate <span style="color:#f92672">(</span>public key<span style="color:#f92672">)</span>, to present to the server. Must also provide -key option.
</span></span><span style="display:flex;"><span>      --key<span style="color:#f92672">=</span>                   File containing client private key, to present to the server. Must also provide -cert option.
</span></span><span style="display:flex;"><span>      --cname<span style="color:#f92672">=</span>                 Server name override when validating TLS certificate - useful <span style="color:#66d9ef">for</span> self signed certs.
</span></span><span style="display:flex;"><span>      --skipTLS                Skip TLS client verification of the server<span style="color:#e6db74">&#39;s certificate chain and host name.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      --skipFirst=0            Skip the first X requests when doing the results tally.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      --insecure               Use plaintext and insecure connection.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      --authority=             Value to be used as the :authority pseudo-header. Only works if -insecure is used.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -c, --concurrency=50         Number of requests to run concurrently. Total number of requests cannot be smaller than the concurrency level. Default is 50.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -n, --total=200              Number of requests to run. Default is 200.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -q, --qps=0                  Rate limit, in queries per second (QPS). Default is no rate limit.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -t, --timeout=20s            Timeout for each request. Default is 20s, use 0 for infinite.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -z, --duration=0             Duration of application to send requests. When duration is reached, application stops and exits. If duration is specified, n is ignored. Examples: -z 10s -z 3m.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -x, --max-duration=0         Maximum duration of application to send requests with n setting respected. If duration is reached before n requests are completed, application stops and exits. Examples: -x
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               10s -x 3m.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      --duration-stop=&#34;close&#34;  Specifies how duration stop is reported. Options are close, wait or ignore.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  -d, --data=                  The call data as stringified JSON. If the value is &#39;</span>@<span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#66d9ef">then</span> the request contents are read from stdin.
</span></span><span style="display:flex;"><span>  -D, --data-file<span style="color:#f92672">=</span>             File path <span style="color:#66d9ef">for</span> call data JSON file. Examples: /home/user/file.json or ./file.json.
</span></span><span style="display:flex;"><span>  -b, --binary                 The call data comes as serialized binary message or multiple count-prefixed messages read from stdin.
</span></span><span style="display:flex;"><span>  -B, --binary-file<span style="color:#f92672">=</span>           File path <span style="color:#66d9ef">for</span> the call data as serialized binary message or multiple count-prefixed messages.
</span></span><span style="display:flex;"><span>  -m, --metadata<span style="color:#f92672">=</span>              Request metadata as stringified JSON.
</span></span><span style="display:flex;"><span>  -M, --metadata-file<span style="color:#f92672">=</span>         File path <span style="color:#66d9ef">for</span> call metadata JSON file. Examples: /home/user/metadata.json or ./metadata.json.
</span></span><span style="display:flex;"><span>      --stream-interval<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>      Interval <span style="color:#66d9ef">for</span> stream requests between message sends.
</span></span><span style="display:flex;"><span>      --reflect-metadata<span style="color:#f92672">=</span>      Reflect metadata as stringified JSON used only <span style="color:#66d9ef">for</span> reflection request.
</span></span><span style="display:flex;"><span>  -o, --output<span style="color:#f92672">=</span>                Output path. If none provided stdout is used.
</span></span><span style="display:flex;"><span>  -O, --format<span style="color:#f92672">=</span>                Output format. One of: summary, csv, json, pretty, html, influx-summary, influx-details. Default is summary.
</span></span><span style="display:flex;"><span>      --connections<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>          Number of connections to use. Concurrency is distributed evenly among all the connections. Default is 1.
</span></span><span style="display:flex;"><span>      --connect-timeout<span style="color:#f92672">=</span>10s    Connection timeout <span style="color:#66d9ef">for</span> the initial connection dial. Default is 10s.
</span></span><span style="display:flex;"><span>      --keepalive<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>            Keepalive time duration. Only used <span style="color:#66d9ef">if</span> present and above 0.
</span></span><span style="display:flex;"><span>      --name<span style="color:#f92672">=</span>                  User specified name <span style="color:#66d9ef">for</span> the test.
</span></span><span style="display:flex;"><span>      --tags<span style="color:#f92672">=</span>                  JSON representation of user-defined string tags.
</span></span><span style="display:flex;"><span>      --cpus<span style="color:#f92672">=</span><span style="color:#ae81ff">8</span>                 Number of cpu cores to use.
</span></span><span style="display:flex;"><span>      --debug<span style="color:#f92672">=</span>                 The path to debug log file.
</span></span><span style="display:flex;"><span>  -e, --enable-compression     Enable Gzip compression on requests.
</span></span><span style="display:flex;"><span>  -v, --version                Show application version.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Args:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>&lt;host&gt;<span style="color:#f92672">]</span>  Host and port to test.
</span></span></code></pre></div><p>需要关注的几个参数：</p>
<ul>
<li>
<p><code>--skipTLS --insecure</code>：如果服务不支持 <code>HTTPS</code> 的话，可以使用此参数跳过 <code>TLS</code> 验证；</p>
</li>
<li>
<p><code>--protoset</code>：指定本次运行的 <code>protoset</code> 文件路径，即上面生成的 <code>api.bundle.protoset</code>；</p>
</li>
<li>
<p><code>--call</code>：需要调用的方法名，格式为：<code>包名.服务名.方法名</code>。比如我要调用 <code>offerpb</code> 包下的 <code>ApiService</code> 服务的 <code>CreateSKUAssociations</code> 方法，那么 <code>call</code> 参数应该是： <code>--call offerpb.ApiService.CreateSKUAssociations</code>；</p>
</li>
<li>
<p><code>--data</code>：本次请求的参数，通过 <code>jsonString</code> 的格式传入；</p>
</li>
<li>
<p><code>--data-file</code>：本次请求的参数，只不过通过文件的形式传入，文件中是标准的通过 <code>json</code> 序列化后的数据；</p>
</li>
<li>
<p><code>--metadata</code>：<code>metadata</code> 参数，通过 <code>jsonString</code> 的格式传入；</p>
</li>
<li>
<p><code>-c</code>：并发数，默认 50(这里有坑，具体参照官网解释：<a href="https://ghz.sh/docs/options#-c---concurrency">-c</a>。虽然会其多个 <code>goroutine</code>，但是所有的 <code>goroutine</code> 会公用一个连接)；</p>
</li>
<li>
<p><code>-n</code>：请求数，默认 200。<code>n</code> 不能小于 <code>c</code>。</p>
</li>
</ul>
<p>假设 <code>ApiService</code>服务的地址是：<code>localhost:58784</code>。我们执行下面的命令，发起一次压测任务：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ ghz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--skipTLS --insecure --protoset /Users/hujiaming/go/src/hujm.net/api.bundle.protoset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--call offerpb.ApiService.CreateSKUAssociations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--data <span style="color:#e6db74">&#39;{&#34;associations&#34;:[{&#34;sku_code&#34;: &#34;test:6985079117562211244&#34;,&#34;offer_id&#34;: 8629237865019910744,&#34;author&#34;: &#34;test_by_ghz&#34;}]}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;test&#34;}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-c <span style="color:#ae81ff">100</span> -n <span style="color:#ae81ff">1000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>localhost:58784 
</span></span></code></pre></div><p>当你的请求参数比较多时，将他们放在一个文件中、然后使用 <code>--data-file</code> 参数是更好的选择：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat test_data.json
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;associations&#34;</span>: <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;sku_code&#34;</span>: <span style="color:#e6db74">&#34;test:6237052533738512496&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;offer_id&#34;</span>: 5655307241153104444,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;test_by_ghz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;sku_code&#34;</span>: <span style="color:#e6db74">&#34;test:2156276639623439583&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;offer_id&#34;</span>: 6360134836979240095,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;test_by_ghz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;sku_code&#34;</span>: <span style="color:#e6db74">&#34;test:8361104385030719827&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;offer_id&#34;</span>: 3705044490439993926,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;test_by_ghz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;sku_code&#34;</span>: <span style="color:#e6db74">&#34;test:6023087259299523902&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;offer_id&#34;</span>: 3776027093787512475,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;test_by_ghz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;sku_code&#34;</span>: <span style="color:#e6db74">&#34;test:9196748606623463644&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;offer_id&#34;</span>: 1506864634761125694,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;author&#34;</span>: <span style="color:#e6db74">&#34;test_by_ghz&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ ghz <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--skipTLS --insecure --protoset /Users/hujiaming/go/src/hujm.net/api.bundle.protoset <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--call offerpb.ApiService.CreateSKUAssociations <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--data-file /Users/hujiaming/go/src/hujm.net/test_data.json <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-m <span style="color:#e6db74">&#39;{&#34;name&#34;: &#34;test&#34;}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>-c <span style="color:#ae81ff">100</span> -n <span style="color:#ae81ff">1000</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>localhost:58784 
</span></span></code></pre></div><p>看下输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Summary:
</span></span><span style="display:flex;"><span>  Count:	<span style="color:#ae81ff">1000</span>
</span></span><span style="display:flex;"><span>  Total:	743.17 ms
</span></span><span style="display:flex;"><span>  Slowest:	194.74 ms
</span></span><span style="display:flex;"><span>  Fastest:	37.67 ms
</span></span><span style="display:flex;"><span>  Average:	69.32 ms
</span></span><span style="display:flex;"><span>  Requests/sec:	1345.59
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Response time histogram:
</span></span><span style="display:flex;"><span>  37.670 <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>	|
</span></span><span style="display:flex;"><span>  53.377 <span style="color:#f92672">[</span>384<span style="color:#f92672">]</span>	|∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎
</span></span><span style="display:flex;"><span>  69.084 <span style="color:#f92672">[</span>349<span style="color:#f92672">]</span>	|∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎
</span></span><span style="display:flex;"><span>  84.791 <span style="color:#f92672">[</span>138<span style="color:#f92672">]</span>	|∎∎∎∎∎∎∎∎∎∎∎∎∎∎
</span></span><span style="display:flex;"><span>  100.498 <span style="color:#f92672">[</span>26<span style="color:#f92672">]</span>	|∎∎∎
</span></span><span style="display:flex;"><span>  116.205 <span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>	|
</span></span><span style="display:flex;"><span>  131.912 <span style="color:#f92672">[</span>0<span style="color:#f92672">]</span>	|
</span></span><span style="display:flex;"><span>  147.619 <span style="color:#f92672">[</span>16<span style="color:#f92672">]</span>	|∎∎
</span></span><span style="display:flex;"><span>  163.326 <span style="color:#f92672">[</span>33<span style="color:#f92672">]</span>	|∎∎∎
</span></span><span style="display:flex;"><span>  179.033 <span style="color:#f92672">[</span>17<span style="color:#f92672">]</span>	|∎∎
</span></span><span style="display:flex;"><span>  194.739 <span style="color:#f92672">[</span>34<span style="color:#f92672">]</span>	|∎∎∎∎
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Latency distribution:
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">10</span> % in 46.59 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">25</span> % in 49.94 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">50</span> % in 57.28 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">75</span> % in 69.51 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">90</span> % in 102.33 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">95</span> % in 163.38 ms
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">99</span> % in 183.99 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Status code distribution:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>OK<span style="color:#f92672">]</span>   <span style="color:#ae81ff">1000</span> responses
</span></span></code></pre></div><p><code>Summary</code> 的参数：</p>
<ul>
<li><code>Count</code>：完成的请求总数，包括成功的和失败的；</li>
<li><code>Total</code>：本次请求所用的总时长，从 <code>ghz</code> 启动一直到结束；</li>
<li><code>Slowest</code>：最慢的某次请求的时间；</li>
<li><code>Fastest</code>：最快的某个请求的时间；</li>
<li><code>Average</code>：<code>(所有请求的响应时间) / Count</code>。</li>
<li><code>Requests/sec</code>：<code>RTS</code>，<code>Count / Total</code> 的值。</li>
</ul>
<h2 id="三参考资料">三、参考资料<a hidden class="anchor" aria-hidden="true" href="#三参考资料">#</a></h2>
<ul>
<li><a href="https://github.com/bojand/ghz">https://github.com/bojand/ghz</a></li>
<li><a href="https://ghz.sh/">Simple gRPC benchmarking and load testing tool</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/%E6%95%88%E7%8E%87/">效率</a></li>
      <li><a href="http://localhost:1313/tags/ghz/">Ghz</a></li>
      <li><a href="http://localhost:1313/tags/%E5%8E%8B%E6%B5%8Bgrpc%E6%8E%A5%E5%8F%A3/">压测GRPC接口</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">hujm2023&#39;s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
